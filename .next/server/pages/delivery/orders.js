"use strict";(()=>{var e={};e.id=748,e.ids=[748,660],e.modules={8409:(e,t,r)=>{r.r(t),r.d(t,{config:()=>v,default:()=>h,getServerSideProps:()=>y,getStaticPaths:()=>b,getStaticProps:()=>g,reportWebVitals:()=>f,routeModule:()=>P,unstable_getServerProps:()=>w,unstable_getServerSideProps:()=>_,unstable_getStaticParams:()=>N,unstable_getStaticPaths:()=>j,unstable_getStaticProps:()=>S});var s={};r.r(s),r.d(s,{default:()=>DeliveryOrders});var i=r(7093),a=r(5244),l=r(1323),n=r(9209),d=r.n(n),o=r(5913),c=r(997),u=r(6689),p=r(8755),x=r(1163);function DeliveryPhoneLogin({createIfNotFound:e=!1}){let[t,r]=(0,u.useState)(""),[s,i]=(0,u.useState)(!1),[a,l]=(0,u.useState)(null),n=(0,x.useRouter)();async function handleSubmit(r){if(r.preventDefault(),l(null),!t||t.trim().length<6){l("Please enter a valid mobile number");return}i(!0);try{let r=await fetch("/api/delivery/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:t.trim(),createIfNotFound:e})}),s=await r.text();console.log("[delivery login] status:",r.status,"body:",s);let a=null;try{a=JSON.parse(s)}catch(e){a=s}if(!r.ok){let e=a&&a.error?a.error:"Login failed";l(e),i(!1);return}let d=a.id,o=a.name||a.phone||"Delivery",c=a.phone||t.trim();localStorage.setItem("delivery_user",JSON.stringify({id:d,name:o,phone:c})),window.dispatchEvent(new Event("delivery-login")),await n.replace("/delivery/orders"),window.location.reload()}catch(e){console.error("Login error",e),l(e?.message||"Network error")}finally{i(!1)}}return(0,c.jsxs)("form",{onSubmit:handleSubmit,className:"max-w-sm mx-auto bg-white p-4 rounded shadow",children:[c.jsx("h3",{className:"font-semibold mb-3",children:"Delivery partner login (mobile)"}),c.jsx("label",{className:"text-xs text-gray-600 block mb-1",children:"Mobile number"}),c.jsx("input",{value:t,onChange:e=>r(e.target.value),placeholder:"e.g. 9876543210",className:"w-full border px-3 py-2 rounded mb-2",inputMode:"numeric"}),a&&c.jsx("div",{className:"text-sm text-red-600 mb-2",children:a}),(0,c.jsxs)("div",{className:"flex gap-2",children:[c.jsx("button",{type:"submit",disabled:s,className:"px-4 py-2 bg-indigo-600 text-white rounded",children:s?"Signing in…":"Sign in"}),c.jsx("button",{type:"button",onClick:()=>{r(""),l(null)},className:"px-3 py-2 border rounded",children:"Clear"})]}),c.jsx("p",{className:"mt-3 text-xs text-gray-500",children:"This is a quick login for testing. Use proper auth in production."})]})}var m=r(1649);function DeliveryOrders(){let{data:e,status:t}=(0,m.useSession)(),[r,s]=(0,u.useState)(null),[i,a]=(0,u.useState)([]),[l,n]=(0,u.useState)(!1),[d,o]=(0,u.useState)({});(0,u.useEffect)(()=>{try{let e=localStorage.getItem("delivery_user");if(e){let t=JSON.parse(e);t?.id&&s(t.id)}}catch(e){}},[]);let x=(0,u.useMemo)(()=>{let t=e&&e.user?.id||null;return t??r},[e,r]);async function fetchOrdersForDelivery(e){n(!0);try{let t=await fetch("/api/orders",{cache:"no-store"});if(!t.ok){console.error("Failed to fetch orders",await t.text()),a([]);return}let r=await t.json(),s=r.filter(t=>t.assignedTo===e);a(s)}catch(e){console.error("Error fetching orders",e),a([])}finally{n(!1)}}async function updateStatus(e,t){o(t=>({...t,[e]:!0}));try{let r=await fetch("/api/orders",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,action:"status",status:t})});if(!r.ok){let e=await r.text();throw Error(e||"Failed to update status")}let s=await r.json();a(t=>t.map(t=>t._id===e?s:t))}catch(e){console.error("Update failed:",e),alert("Failed to update status: "+(e?.message||""))}finally{o(t=>({...t,[e]:!1}))}}return((0,u.useEffect)(()=>{if(!x)return;fetchOrdersForDelivery(x);let e=setInterval(()=>fetchOrdersForDelivery(x),8e3);return()=>clearInterval(e)},[x]),"loading"===t)?c.jsx(p.Z,{title:"Delivery • Loading",children:c.jsx("div",{className:"py-12 text-center",children:"Loading session…"})}):x?(0,c.jsxs)(p.Z,{title:"Delivery • Orders",children:[(0,c.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[c.jsx("h2",{className:"text-lg font-semibold",children:"My Assigned Orders"}),(0,c.jsxs)("div",{children:[c.jsx("button",{onClick:()=>fetchOrdersForDelivery(x),className:"px-3 py-1 bg-indigo-600 text-white rounded",children:"Refresh"}),(0,c.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["Signed in as"," ",c.jsx("strong",{children:e&&e.user?.name||"Delivery"})]})]})]}),l&&c.jsx("div",{className:"text-center py-6",children:"Loading…"}),!l&&0===i.length&&c.jsx("div",{className:"text-center text-gray-500",children:"No assigned orders"}),c.jsx("div",{className:"space-y-3",children:i.map(e=>(0,c.jsxs)("div",{className:"bg-white p-3 rounded shadow mb-3",children:[(0,c.jsxs)("div",{className:"flex justify-between",children:[(0,c.jsxs)("div",{children:[c.jsx("div",{className:"font-medium",children:e.customerName}),c.jsx("div",{className:"text-xs text-gray-500",children:e.address})]}),(0,c.jsxs)("div",{className:"text-right",children:[c.jsx("div",{className:"text-sm",children:e.status}),c.jsx("div",{className:"text-xs",children:new Date(e.createdAt).toLocaleString()})]})]}),(0,c.jsxs)("div",{className:"mt-3 flex gap-2",children:[c.jsx("button",{onClick:()=>updateStatus(e._id,"picked"),disabled:d[e._id]||"picked"===e.status||"completed"===e.status,className:"px-2 py-1 rounded border disabled:opacity-50",children:"Picked"}),c.jsx("button",{onClick:()=>updateStatus(e._id,"in_transit"),disabled:d[e._id]||"in_transit"===e.status||"completed"===e.status,className:"px-2 py-1 rounded border disabled:opacity-50",children:"In Transit"}),c.jsx("button",{onClick:()=>updateStatus(e._id,"completed"),disabled:d[e._id]||"completed"===e.status,className:"px-2 py-1 rounded border bg-green-50 disabled:opacity-50",children:"Complete"})]})]},e._id))})]}):c.jsx(p.Z,{title:"Delivery • Sign in",children:(0,c.jsxs)("div",{className:"py-8 max-w-lg mx-auto space-y-6",children:[c.jsx("p",{className:"text-center",children:"Sign in with mobile number to view your assigned orders."}),c.jsx(DeliveryPhoneLogin,{createIfNotFound:!0}),(0,c.jsxs)("div",{className:"text-center text-sm text-gray-500",children:["or"," ",c.jsx("button",{onClick:()=>(0,m.signIn)(),className:"text-indigo-600 underline",children:"sign in with account"})]})]})})}let h=(0,l.l)(s,"default"),g=(0,l.l)(s,"getStaticProps"),b=(0,l.l)(s,"getStaticPaths"),y=(0,l.l)(s,"getServerSideProps"),v=(0,l.l)(s,"config"),f=(0,l.l)(s,"reportWebVitals"),S=(0,l.l)(s,"unstable_getStaticProps"),j=(0,l.l)(s,"unstable_getStaticPaths"),N=(0,l.l)(s,"unstable_getStaticParams"),w=(0,l.l)(s,"unstable_getServerProps"),_=(0,l.l)(s,"unstable_getServerSideProps"),P=new i.PagesRouteModule({definition:{kind:a.x.PAGES,page:"/delivery/orders",pathname:"/delivery/orders",bundlePath:"",filename:""},components:{App:o.default,Document:d()},userland:s})},1649:e=>{e.exports=require("next-auth/react")},2785:e=>{e.exports=require("next/dist/compiled/next-server/pages.runtime.prod.js")},6689:e=>{e.exports=require("react")},6405:e=>{e.exports=require("react-dom")},997:e=>{e.exports=require("react/jsx-runtime")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")}};var t=require("../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[209,450,609,792,588,664,201,763,646,163,688],()=>__webpack_exec__(8409));module.exports=r})();